= Pipelines
include::_attributes.adoc[]

[#introduction]
== Introduction to Tekton

On a Red Hat Enterprise Linux host, install the `tkn` command line tool via a repo:

[source%nowrap,console]
----
sudo dnf copr enable chmouel/tektoncd-cli
sudo dnf install tektoncd-cli -y
----

Install the Red Hat OpenShift Pipelines operator via the OperatorHub in the OpenShift web console or via the command-line:


With a user that has cluster-admin:

[source%nowrap,console]
----
vi subscription.yaml
----

[source%nowrap,console]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-pipelines-operator
  namespace: openshift-operators
spec:
  channel: ocp-4.5
  name: openshift-pipelines-operator-rh 
  source: redhat-operators 
  sourceNamespace: openshift-marketplace
----

[source%nowrap,console]
----
oc apply -f subscription.yaml
----

With both the command line tool and pipline deplyed on the OpenShift cluster, test the command: 

[source%nowrap,console]
----
tkn version
----

[source%nowrap,console]
----
Client version: 0.21.0
Pipeline version: v0.24.3
Triggers version: v0.14.2
----


=== Pipeline Project

Create a pipeline project, preferably with a user such as a developer:

[source%nowrap,console]
----
oc new-project pipeline-project
----

Check the pipeline service account is present:

[source%nowrap,console]
----
oc get serviceaccount pipeline
----

Example output:

[source%nowrap,console]
----
NAME       SECRETS   AGE
pipeline   2         14s
----

=== Create pipeline resources

Adding resources can be done via the CLI using the `tkn` or `oc` commands.

==== Type Git Using tkn

Listing resource will return `No pipelineresources found.`, because none have been created yet:

[source%nowrap,console]
----
tkn resource list
----

[source%nowrap,console]
----
tkn resource create
----

[source%nowrap,console]
----
? Enter a name for a pipeline resource : fastapi-project-repo
? Select a resource type to create : git
? Enter a value for url :  https://github.com/rwalker-redhat/fastapi-quickstart.git
? Enter a value for revision :  main
New git resource "fastapi-project-repo" has been created
----

List the resources again:

[source%nowrap,console]
----
tkn resource list
----

[source%nowrap,console]
----
NAME                   TYPE   DETAILS
fastapi-project-repo   git    url: https://github.com/rwalker-redhat/fastapi-quickstart.git
----

You can view the resource via the OpenShift web console under "Pipelines/Pipelines" and the PipelineResources tab. 

image::pipeline-resources.png[]

And delete the resource with:

[source%nowrap,console]
----
tkn resource delete fastapi-project-repo
----

==== Type Git Using oc

[source%nowrap,console]
----
mkdir ocp
----

[source%nowrap,console]
----
vi ocp/tkn_git_resource.yaml 
----

[source%nowrap,yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: fastapi-project-repo
  namespace: pipeline-project
spec:
  params:
    - name: url
      value: 'https://github.com/rwalker-redhat/fastapi-quickstart.git'
    - name: revision
      value: main
  type: git
----

[source%nowrap,console]
----
oc create -f ocp/tkn_git_resource.yaml
----

==== Type image using tkn

This defines the target container image, which will be created using source to image and stored in the local OpenShift image registry.

It's critical the image URL specifies the project name you're working in:

[source%nowrap,console]
----
tkn resource create
----

[source%nowrap,console]
----
? Enter a name for a pipeline resource : fastapi-project-image
? Enter a value for url :  default-route-openshift-image-registry.apps-crc.testing/pipeline-project/fastapi-example-img:latest
? Select a resource type to create : image
? Enter a value for digest :  
New image resource "fastapi-project-image" has been created
----


==== Type image using oc

[source%nowrap,console]
----
vi openshift-pipeline/tkn_image_resource.yaml
----

[source%nowrap,yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: fastapi-project-image
  namespace: pipeline-project
spec:
  type: image
  params:
    - name: url
      value: 'default-route-openshift-image-registry.apps-crc.testing/pipeline-project/'
    - name: digest
      value: 
----

[source%nowrap,console]
----
oc create -f openshift-pipeline/tkn_image_resource.yaml
----

=== Tekton Cluster Tasks

You can browse the OpenShift Pipeline Cluster Tasks via the web console under Pipelines -> Cluster Tasks or alternatively, via the CLI:

[source%nowrap,console]
----
oc project pipeline-project
----

[source%nowrap,console]
----
oc get ClusterTasks
----

If you don't wish to use the standard s2i-python-3 Cluster Task it's easy to create a new custom Cluster Tasks by copying an existing and modifying it to use our own image.

You can view an exiting task with:

[source%nowrap,console]
----
oc edit ClusterTasks s2i-python-3
----

You can copy the core contents and customize to your needs

TIP: To change the default editor in bash use `export VISUAL=vi` and `export EDITOR="$VISUAL"`. 

Here is the complete custom Cluster Task YAML:

[source%nowrap,console]
----
vi ocp/tkn_cluster_task.yaml
----


[source%nowrap,console]
----
oc create -f ocp/tkn_cluster_task.yaml
----

=== Basic Pipeline

Before steaming ahead, it's maybe a good point to run a basic example to understand how Pipeline tasks are added and then a pipeline created to utilise those tasks.

Create a task:

[source%nowrap,console]
----
vi basic_task.yaml
----

[source%nowrap,console]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: basic-task
  namespace: pipeline-project
spec:
  params:
    - name: taskAppName
      type: string
  steps:
    - image: registry.redhat.io/ubi8/python-36
      command:
        - /usr/bin/python3
        - '-c'
        - print ("$(inputs.params.taskAppName)")
----

[source%nowrap,console]
----
oc create -f openshift-pipeline/basic_task.yaml
----

Create a pipeline: 

[source%nowrap,console]
----
vi tkn_pipeline.yaml
----

[source%nowrap,console]
----
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: basic-pipeline
  namespace: pipeline-project
spec:
  params:
    - default: default
      description: pipeAppName
      name: pipeAppName
      type: string
  tasks:
    - name: basic-task
      params:
        - name: taskAppName
          value: $(params.pipeAppName)
      taskRef:
        kind: Task
        name: basic-task
----

[source%nowrap,console]
----
oc create -f tkn_pipeline.yaml
----

Run basic pipeline, you can run the pipeline via the web console or the CLI:

[source%nowrap,console]
----
tkn pipeline list
tkn pipeline start test-pipeline
----

The CLI prompts for the `pipeAppName`` string and provides the command to track its progress, for example:

[source%nowrap,console]
----
tkn pipelinerun logs basic-pipeline-run-79qts -f -n pipeline-project
----

=== Python s2i Pipeline

==== Pipeline Tasks

These next two tasks are carbon copies of the tasks from:app-name: 

https://raw.githubusercontent.com/openshift/pipelines-tutorial/pipelines-1.5/01_pipeline/01_apply_manifest_task.yaml

https://raw.githubusercontent.com/openshift/pipelines-tutorial/pipelines-1.5/01_pipeline/02_update_deployment_task.yaml

The `tkn_apply_manifests_task.yaml`` uses the `oc` command to apply the YAML files under k8s directory (that we'll add shortly).

[source%nowrap,console]
----
vi openshift-pipeline/tkn_apply_manifests_task.yaml
----

[source%nowrap,yaml]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: apply-manifests
spec:
  resources:
    inputs:
      - {type: git, name: source}
  params:
    - name: manifest_dir
      description: The directory in source that contains yaml manifests
      type: string
      default: "k8s"
  steps:
    - name: apply
      image: quay.io/openshift/origin-cli:latest
      workingDir: /workspace/source
      command: ["/bin/bash", "-c"]
      args:
        - |-
          echo Applying manifests in $(inputs.params.manifest_dir) directory
          oc apply -f $(inputs.params.manifest_dir)
          echo -----------------------------------
----

[source%nowrap,console]
----
oc create -f openshift-pipeline/tkn_apply_manifests_task.yaml
----

The `tkn_update_deployment_image_task.yaml` uses the `oc`` command to patch the deployment to use the container built in the `s2i-build-image` task, which (once executed) should equal the URL as defined in the image resource defined earlier e.g. `image-registry.openshift-image-registry.svc:5000/pipeline-project/django-example-img:latest`.

[source%nowrap,console]
----
vi openshift-pipeline/tkn_update_deployment_image_task.yaml
----

[source%nowrap,console]
----
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-deployment
spec:
  resources:
    inputs:
      - {type: image, name: image}
  params:
    - name: deployment
      description: The name of the deployment patch the image
      type: string
  steps:
    - name: patch
      image: quay.io/openshift/origin-cli:latest
      command: ["/bin/bash", "-c"]
      args:
        - |-
          oc patch deployment $(inputs.params.deployment) --patch='{"spec":{"template":{"spec":{
            "containers":[{
              "name": "$(inputs.params.deployment)",
              "image":"$(inputs.resources.image.url)"
            }]
          }}}}'
----

[source%nowrap,console]
----
oc create -f openshift-pipeline/tkn_update_deployment_image_task.yaml
----

List the new tasks:

[source%nowrap,console]
----
tkn task list
----

[source%nowrap,console]
----
NAME                DESCRIPTION   AGE
apply-manifests                   8 minutes ago
basic-task                        26 minutes ago
update-deployment                 8 minutes ago
----

Create a pipeline:

[source%nowrap,console]
----
oc create -f ocp/tkn_pipeline.yaml
----

[source%nowrap,console]
----
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build-and-deploy
spec:
  workspaces:
  - name: shared-workspace
  params:
  - name: deployment-name
    type: string
    description: name of the deployment to be patched
  - name: git-url
    type: string
    description: url of the git repo for the code of deployment
  - name: git-revision
    type: string
    description: revision to be used from repo of the code for deployment
    default: "pipelines-1.5"
  - name: IMAGE
    type: string
    description: image to be built from the code
  tasks:
  - name: fetch-repository
    taskRef:
      name: git-clone
      kind: ClusterTask
    workspaces:
    - name: output
      workspace: shared-workspace
    params:
    - name: url
      value: $(params.git-url)
    - name: subdirectory
      value: ""
    - name: deleteExisting
      value: "true"
    - name: revision
      value: $(params.git-revision)
  - name: build-image
    taskRef:
      name: buildah
      kind: ClusterTask
    params:
    - name: IMAGE
      value: $(params.IMAGE)
    workspaces:
    - name: source
      workspace: shared-workspace
    runAfter:
    - fetch-repository
  - name: apply-manifests
    taskRef:
      name: apply-manifests
    workspaces:
    - name: source
      workspace: shared-workspace
    runAfter:
    - build-image
  - name: update-deployment
    taskRef:
      name: update-deployment
    params:
    - name: deployment
      value: $(params.deployment-name)
    - name: IMAGE
      value: $(params.IMAGE)
    runAfter:
    - apply-manifests
----

[source%nowrap,console]
----
oc create -f ocp/tkn_pipeline.yaml
----

==== Running Pipeline

The pipeline was created using pre-defined tasks, the pipeline will be executed using pre-defined recourses. 

List the resources defined earlier:

[source%nowrap,console]
----
tkn resource list
----

Ref:

[source%nowrap,console]
----
tkn pipeline start build-and-deploy \
    -w name=shared-workspace,volumeClaimTemplateFile=https://raw.githubusercontent.com/openshift/pipelines-tutorial/pipelines-1.5/01_pipeline/03_persistent_volume_claim.yaml \
    -p deployment-name=pipelines-vote-api \
    -p git-url=https://github.com/openshift/pipelines-vote-api.git \
    -p IMAGE=image-registry.openshift-image-registry.svc:5000/pipelines-tutorial/pipelines-vote-api \
    --use-param-defaults
----